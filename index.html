<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CloudForge é›²åŒ æ§åˆ¶ç³»çµ±</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/020617/38bdf8?text=MSNCH">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        :root { --bg: #020617; --card: #1e293b; --blue: #38bdf8; --red: #ef4444; --green: #22c55e; --text: #f1f5f9; }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; 
            margin: 0; padding: env(safe-area-inset-top) 15px 15px 15px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* 2è™Ÿå‘¼å¸ç‡ˆæ ¸å¿ƒå‹•ç•« */
        .led { width: 14px; height: 14px; border-radius: 50%; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .breathe { background: var(--blue); animation: b 2s infinite ease-in-out; box-shadow: 0 0 10px var(--blue); }
        .steady { background: var(--blue); box-shadow: 0 0 15px var(--blue); opacity: 1; } /* æ•…éšœé•·äº® */
        .off { background: #334155; }
        @keyframes b { 0%,100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }

        /* é ‚éƒ¨æ§åˆ¶å€ */
        .admin-zone { 
            width: 100%; max-width: 500px; background: #0f172a; border: 2px solid var(--blue); 
            padding: 20px; border-radius: 20px; margin: 15px 0; text-align: center; box-sizing: border-box;
        }

        /* ç¶²æ ¼ä½ˆå±€ */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; width: 100%; max-width: 900px; }
        .card { background: var(--card); border-radius: 18px; padding: 18px; border: 1px solid #334155; position: relative; transition: 0.3s; }
        .card.offline { border: 1px dashed var(--red); opacity: 0.7; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; -webkit-tap-highlight-color: transparent; }
        .unlock { background: var(--blue); color: #020617; width: 100%; font-size: 1rem; margin-top: 10px; }
        .stop-all { background: var(--red); width: 100%; font-size: 1.1rem; border: 2px solid white; margin-top: 10px; display: none; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.6; } }

        .ctrl-btns { display: none; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-on { background: var(--green); }
        .btn-off { background: var(--red); }

        /* æ—¥èªŒè¦–çª— */
        #log { 
            width: 100%; max-width: 900px; height: 120px; background: #000; color: #10b981; 
            font-family: monospace; font-size: 11px; padding: 15px; margin-top: 20px; 
            overflow-y: auto; border-radius: 15px; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div style="text-align:center; margin-top:10px;">
        <h2 style="color:var(--blue); margin:0;">CloudForge é›²åŒ </h2>
        <small style="color:#64748b;">1+5 å‰¯æ¿å…¨æ™¯ç›£æ§ç³»çµ±</small>
    </div>

    <div class="admin-zone">
        <div id="status-txt">ğŸ”’ å®‰å…¨é–å®šï¼šç›£æ§æ¨¡å¼</div>
        <button class="unlock" id="unlockBtn" onclick="doUnlock()">äººå·¥æˆæ¬Šè§£é–</button>
        <button class="stop-all" id="stopBtn" onclick="masterStop()">ğŸš¨ è¬ä¸å¾—å·²ï¼šä¸€éµå…¨åœ</button>
    </div>

    <div class="grid" id="ui-grid">
        <div class="card" id="card-A1">
            <h3 style="margin:0;"><span id="led-A1" class="led off"></span>ä¸»æ¿ A1</h3>
            <div id="m-data" style="font-size:13px; margin-top:10px; color:#94a3b8;">ç­‰å¾…å¿ƒè·³è¨Šè™Ÿ...</div>
        </div>
        </div>

    <div id="log">>> é›²åŒ ç³»çµ±åˆå§‹åŒ–æˆåŠŸ...<br>>> æ­£åœ¨é€£ç·š MQTT ä¼ºæœå™¨...</div>

    <script>
        // --- æ ¸å¿ƒå¸³å¯†è¨­å®š (æ‚¨è¨˜å¾—ä½çš„é€™çµ„) ---
        const mqttCfg = {
            url: 'wss://broker.hivemq.com:8884/mqtt',
            user: 'MSNCHHOME',
            pass: 'CloudForge2025'
        };

        let client = mqtt.connect(mqttCfg.url, { username: mqttCfg.user, password: mqttCfg.pass });
        let isAuth = false;

        // ç”Ÿæˆ C1-C5 ä»‹é¢
        const grid = document.getElementById('ui-grid');
        for(let i=1; i<=5; i++) {
            grid.innerHTML += `
                <div class="card offline" id="card-C${i}">
                    <h3 style="margin:0;"><span id="led-C${i}" class="led off"></span>å‰¯æ¿ C${i}</h3>
                    <div style="font-size:13px; margin:10px 0;">æ°´ä½ï¼š<b id="val-C${i}">--</b> %</div>
                    <div class="ctrl-btns" id="ctrl-C${i}">
                        <button class="btn-on" onclick="send('C${i}','ON')">å•Ÿå‹•</button>
                        <button class="btn-off" onclick="send('C${i}','OFF')">åœæ­¢</button>
                    </div>
                </div>
            `;
        }

        function addLog(msg) {
            const l = document.getElementById('log');
            l.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + l.innerHTML;
            l.scrollTop = l.scrollHeight;
        }

        function doUnlock() {
            if(prompt("è«‹è¼¸å…¥ç®¡ç†å¯†é‘°ï¼š") === "CloudForge2025") {
                isAuth = true;
                document.querySelectorAll('.ctrl-btns').forEach(el => el.style.display = 'grid');
                document.getElementById('unlockBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('status-txt').innerText = "ğŸ”“ å·²å–å¾—æœ€é«˜æ“ä½œæ¬Šé™";
                addLog("è­¦å‘Šï¼šç®¡ç†å“¡å·²äººå·¥è§£é–æ“ä½œåŠŸèƒ½");
            } else {
                alert("å¯†é‘°éŒ¯èª¤ï¼");
            }
        }

        client.on('connect', () => {
            addLog("MQTT ä¼ºæœå™¨é€£ç·šæˆåŠŸ");
            client.subscribe('cloudforge/#');
            document.getElementById('led-A1').className = 'led breathe'; // A1 é–‹å§‹å‘¼å¸
        });

        // æ¨¡æ“¬æ‚¨çš„å¯¦æ¸¬ï¼šé€£ç·šä¸­æ–·å‰‡ 2 è™Ÿç‡ˆé•·äº®
        client.on('close', () => {
            document.getElementById('led-A1').className = 'led steady';
            addLog("é€£ç·šä¸­æ–·ï¼ä¸»æ¿ A1 å¯èƒ½å·²æ–·é›»æˆ–å¤±è¯");
        });

        client.on('message', (topic, message) => {
            const msg = message.toString();
            // è§£æå„æ¿ç‹€æ…‹
            if(topic.includes('status')) {
                const id = topic.split('/')[1]; // å‡è¨­ topic æ˜¯ cloudforge/C1/status
                const card = document.getElementById(`card-${id}`);
                const led = document.getElementById(`led-${id}`);
                if(card) {
                    card.classList.remove('offline');
                    led.className = 'led breathe';
                    // æ›´æ–°æ•¸å€¼é‚è¼¯å¯åœ¨æ­¤æ“´å……
                }
            }
        });

        function send(id, cmd) {
            if(!isAuth) return;
            client.publish(`cloudforge/${id}/command`, cmd);
            addLog(`æŒ‡ä»¤ç™¼é€ï¼š${id} -> ${cmd}`);
        }

        function masterStop() {
            if(confirm("ğŸš¨ è­¦å‘Šï¼šç¢ºå®šè¦ç·Šæ€¥é—œé–‰æ‰€æœ‰ç³»çµ±å—ï¼Ÿ")) {
                client.publish(`cloudforge/all/command`, "STOP_ALL");
                addLog("ğŸš¨ åŸ·è¡Œã€ä¸€éµå…¨åœã€ç·Šæ€¥æŒ‡ä»¤ï¼");
            }
        }
    </script>
</body>
</html>